<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Messages - Lovculator ğŸ’–</title>
  <meta name="description" content="Chat with your matches on Lovculator." />
  <meta name="theme-color" content="#ff4b8d" />

  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="shortcut icon" href="/images/favicon-32x32.png" type="image/png" />
  <link rel="icon" href="/images/favicon.ico" sizes="any" />

  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/messages.css" />
  <link rel="stylesheet" href="/css/layout.css"/>
  
  <style>
    /* Typing Indicator & Skeleton Styles */
    .typing-indicator { display: flex; align-items: center; gap: 4px; }
    .typing-indicator span { width: 6px; height: 6px; background: #666; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes typing { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; } 40% { transform: scale(1); opacity: 1; } }
    .typing-active { color: #ff4b8d !important; }

    /* Skeleton Loading */
    .conversation-skeleton { display: flex; align-items: center; padding: 12px 16px; gap: 12px; }
    .avatar-skeleton { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    .info-skeleton { flex: 1; }
    .line-skeleton { height: 12px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 6px; margin-bottom: 6px; }
    .line-skeleton.short { width: 70%; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>

<body class="messages-page">
  <div id="global-header"></div>

  <main class="messages-layout-wrapper">
    <div class="messages-container">
      <aside class="conversations-sidebar">
        <div class="conversations-header">
          <div class="conversations-header-top">
            <h1><span>ğŸ’¬</span> Messages</h1>
            <button class="new-chat-btn" type="button" id="newChatBtn">+ New</button>
          </div>

          <div class="search-container">
            <input type="text" class="search-input" placeholder="Search conversations..." id="searchConversations" />
            <span class="search-icon">ğŸ”</span>
            <span class="search-clear" id="searchClearBtn">âœ•</span>
          </div>
        </div>

        <div class="conversations-list" id="conversationsList">
          <div class="loading-conversations">
            <div class="conversation-skeleton">
              <div class="avatar-skeleton"></div>
              <div class="info-skeleton"><div class="line-skeleton"></div><div class="line-skeleton short"></div></div>
            </div>
            <div class="conversation-skeleton">
              <div class="avatar-skeleton"></div>
              <div class="info-skeleton"><div class="line-skeleton"></div><div class="line-skeleton short"></div></div>
            </div>
          </div>
        </div>
      </aside>

      <section class="messages-main" id="messagesMain">
        <header class="messages-header">
          <div class="current-chat-info">
            <button id="backToList" class="back-btn" title="Back">â†</button>
            <img src="/images/default-avatar.png" alt="User" class="current-chat-avatar" id="currentChatAvatar" onerror="this.src='/images/default-avatar.png'" />
            <div class="chat-header-text">
              <h3 id="currentChatName">Select a conversation</h3>
              <div class="chat-user-status" id="currentChatStatus">Start chatting to connect</div>
            </div>
          </div>
        </header>

        <div class="messages-list" id="messagesList">
          <div class="empty-conversations">
            <div class="empty-icon">ğŸ’Œ</div>
            <h3>Start Messaging</h3>
            <p>Select a match from the left to start chatting.</p>
          </div>
        </div>

        <div class="message-input-container" id="messageInputContainer" style="display: none">
          <div class="message-input-wrapper">
            <button id="attachBtn" type="button" title="Attach file" class="chat-action-btn">ğŸ“</button>
            <input type="file" id="attachInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none" />

            <button id="emojiBtn" type="button" title="Emoji" class="chat-action-btn">ğŸ˜Š</button>
            <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button id="micBtn" type="button" title="Voice message" class="chat-action-btn">ğŸ™ï¸</button>

            <button id="sendMessageBtn" title="Send">
              <span style="font-size: 18px">â¤</span>
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="offlineIndicator" style="display: none; position: fixed; top: 0; left: 0; width: 100%; background: #e74c3c; color: white; text-align: center; padding: 5px; z-index: 9999;">
    You are offline. Trying to reconnect...
  </div>

  <script src="/js/global-header.js"></script>
  <script src="/js/layout-manager.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/messages.js"></script> 
  <script src="/js/profile.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      console.log("ğŸ“± Messages page DOM loaded");
      
      // 1. Clean up global widget to avoid conflicts
      if (window.messagesManager && typeof window.messagesManager.destroy === 'function') {
        window.messagesManager.destroy();
        window.messagesManager = null;
      }
      
      // 2. Initialize the main Messages Page Logic
      setTimeout(() => {
        if (window.messagesPage && typeof window.messagesPage.init === 'function') {
          window.messagesPage.init().catch(error => {
            console.error("âŒ MessagesPage init failed:", error);
          });
        }
      }, 100);
    });

    // Network Status Handling
    window.addEventListener("offline", () => {
      document.getElementById("offlineIndicator").style.display = "block";
      if (window.messagesPage) window.messagesPage.updateConnectionStatus("disconnected");
    });

    window.addEventListener("online", () => {
      document.getElementById("offlineIndicator").style.display = "none";
      if (window.messagesPage) {
        window.messagesPage.updateConnectionStatus("connected");
        window.messagesPage.loadConversations();
      }
    });

    // Page Visibility (Updates Online/Away Status)
    document.addEventListener("visibilitychange", () => {
      if (!window.wsManager) return;
      
      if (document.hidden) {
        window.wsManager.send({ type: "PRESENCE_UPDATE", status: "away", timestamp: new Date().toISOString() });
      } else {
        window.wsManager.send({ type: "PRESENCE_UPDATE", timestamp: new Date().toISOString() });
        if (window.messagesPage) window.messagesPage.loadConversations();
      }
    });

    // Cleanup on Exit
    window.addEventListener("beforeunload", () => {
      if (window.messagesPage) window.messagesPage.stopTypingIndicator();
    });
  </script>
</body>
</html>