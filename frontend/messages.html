<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Messages - Lovculator üíñ</title>
  <meta name="description" content="Chat with your matches on Lovculator." />
  <meta name="theme-color" content="#ff4b8d" />

  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
  <link rel="shortcut icon" href="/images/favicon-32x32.png" type="image/png" />
  <link rel="icon" href="/images/favicon.ico" sizes="any" />

  <!-- Global styles -->
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/messages.css" />
  <link rel="stylesheet" href="/css/layout.css"/>
  
  <!-- Typing indicator CSS -->
  <style>
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background: #666;
      border-radius: 50%;
      display: inline-block;
      animation: typing 1.4s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
      40% { transform: scale(1); opacity: 1; }
    }
    
    .typing-active {
      color: #ff4b8d !important;
    }
  </style>
</head>

<body class="messages-page">

  <header class="main-header">
    <div class="header-left">
        <a href="/" class="logo">Lovculator</a>
    </div>

    <nav class="header-nav-center">
        <a href="/" class="nav-icon-item active" aria-label="Home">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
</a>
        <a href="/love-stories.html" class="nav-icon-item" aria-label="Love Stories">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail-heart">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
        <polyline points="22,6 12,13 2,6"></polyline>
        <path d="M10 14l2 2 2-2"></path>
    </svg>
</a>

<a href="/love-calculator.html" class="nav-icon-item" aria-label="Love Calculator">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-heart-calculator">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
        <line x1="8" y1="11" x2="16" y2="11" stroke-dasharray="3"></line> 
        <line x1="8" y1="14" x2="16" y2="14" stroke-dasharray="3"></line>
    </svg>
</a>

<a href="/answers.html" class="nav-icon-item" aria-label="Answers">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-4-3H2z"></path>
        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 4-3h6z"></path>
    </svg>
</a>
    </nav>
    <div class="header-right">
        
        <button class="header-icon" id="notificationsBtn" aria-label="Notifications">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bell">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
    </svg>
    <span class="notification-badge hidden" id="notificationBadge"></span>
</button>
        
        <button class="header-icon" id="messagesBtn" aria-label="Messages">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
        <polyline points="22,6 12,13 2,6"></polyline>
    </svg>
    <span class="message-badge hidden" id="messagesBadge"></span>
</button>

        <div class="user-menu">
            <img src="/images/default-avatar.png" alt="Profile" class="user-avatar" id="userAvatar">
            <div class="user-dropdown hidden" id="userDropdown">
                <a href="/profile.html">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
    </svg>
    My Profile
</a>
<a href="/settings.html">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
    </svg>
    Settings
</a>
<a href="/logout" id="logoutBtn">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
    </svg>
    Logout
</a>
            </div>
        </div>
    </div>
</header>
  <main class="messages-layout-wrapper">
    <div class="messages-container">
      <!-- LEFT: CONVERSATIONS LIST -->
      <aside class="conversations-sidebar">
        <div class="conversations-header">
          <div class="conversations-header-top">
            <h1><span>üí¨</span> Messages</h1>
            <button class="new-chat-btn" type="button" id="newChatBtn">
              + New
            </button>
          </div>

          <div class="search-container">
            <input type="text" class="search-input" placeholder="Search conversations..." id="searchConversations" />
            <span class="search-icon">üîç</span>
            <span class="search-clear" id="searchClearBtn">‚úï</span>
          </div>
        </div>

        <div class="conversations-list" id="conversationsList">
          <div class="loading-conversations">
            <div class="conversation-skeleton">
              <div class="avatar-skeleton"></div>
              <div class="info-skeleton">
                <div class="line-skeleton"></div>
                <div class="line-skeleton short"></div>
              </div>
            </div>
            <div class="conversation-skeleton">
              <div class="avatar-skeleton"></div>
              <div class="info-skeleton">
                <div class="line-skeleton"></div>
                <div class="line-skeleton short"></div>
              </div>
            </div>
            <div class="conversation-skeleton">
              <div class="avatar-skeleton"></div>
              <div class="info-skeleton">
                <div class="line-skeleton"></div>
                <div class="line-skeleton short"></div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT: CHAT PANEL -->
      <section class="messages-main" id="messagesMain">
        <header class="messages-header">
          <div class="current-chat-info">
            <button id="backToList" class="back-btn" title="Back">‚Üê</button>
            <img src="/images/default-avatar.png" alt="User" class="current-chat-avatar" id="currentChatAvatar" onerror="this.src='/images/default-avatar.png'" />
            <div class="chat-header-text">
              <h3 id="currentChatName">Select a conversation</h3>
              <div class="chat-user-status" id="currentChatStatus">Start chatting to connect</div>
            </div>
          </div>
        </header>

        <div class="messages-list" id="messagesList">
          <div class="empty-conversations">
            <div class="empty-icon">üíå</div>
            <h3>Start Messaging</h3>
            <p>Select a match from the left to start chatting.</p>
          </div>
        </div>

        <!-- Upload indicator will be injected here -->
        <div class="message-input-container" id="messageInputContainer" style="display: none">
          <div class="message-input-wrapper">
            <button id="attachBtn" type="button" title="Attach file" class="chat-action-btn">üìé</button>
            <input type="file" id="attachInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none" />

            <button id="emojiBtn" type="button" title="Emoji (coming soon)" class="chat-action-btn">üòä</button>

            <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>

            <button id="micBtn" type="button" title="Voice message (coming soon)" class="chat-action-btn">üéôÔ∏è</button>

            <button id="sendMessageBtn" title="Send">
              <span style="font-size: 18px">‚û§</span>
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="offlineIndicator" style="display: none;">
    You are offline. Trying to reconnect...
  </div>

  <!-- WebSocket Debug Panel -->
  <div id="debugPanel" style="position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 10000; max-width: 300px; display: none;">
    <h4 style="margin: 0 0 5px 0;">WebSocket Debug</h4>
    <div id="debugInfo"></div>
    <button onclick="testWebSocket()" style="background: #ff4b8d; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 5px; cursor: pointer;">Test WS</button>
    <button onclick="toggleDebug()" style="background: #666; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 5px; cursor: pointer;">Close</button>
  </div>


  <script src="/js/auth.js"></script>
  <script src="/js/messages.js"></script>
  <script src="/js/profile.js"></script>


  <script>
    // Ensure MessagesManager doesn't interfere
    document.addEventListener("DOMContentLoaded", () => {
      console.log("üì± Messages page DOM loaded");
      
      // If MessagesManager exists, destroy it (we use singleton WS manager)
      if (window.messagesManager && typeof window.messagesManager.destroy === 'function') {
        console.log("üîÑ Destroying MessagesManager on messages page");
        window.messagesManager.destroy();
        window.messagesManager = null;
      }
      
      // Initialize MessagesPage after a slight delay
      setTimeout(() => {
        if (window.messagesPage && typeof window.messagesPage.init === 'function') {
          console.log("üöÄ Initializing MessagesPage...");
          window.messagesPage.init().catch(error => {
            console.error("‚ùå MessagesPage init failed:", error);
          });
        } else {
          console.error("‚ùå MessagesPage not available");
        }
      }, 100);
    });

    // Network status handling
    window.addEventListener("offline", () => {
      console.log("üì∂ Device is offline");
      const offlineEl = document.getElementById("offlineIndicator");
      if (offlineEl) offlineEl.style.display = "block";
      
      if (window.messagesPage) {
        window.messagesPage.updateConnectionStatus("disconnected");
      }
    });

    window.addEventListener("online", () => {
      console.log("üì∂ Device is back online");
      const offlineEl = document.getElementById("offlineIndicator");
      if (offlineEl) offlineEl.style.display = "none";
      
      // Refresh conversations when coming back online
      if (window.messagesPage) {
        window.messagesPage.updateConnectionStatus("connected");
        window.messagesPage.loadConversations();
      }
    });

    // Handle page visibility changes
    document.addEventListener("visibilitychange", () => {
      if (window.messagesPage) {
        if (document.hidden) {
          console.log("üìÑ Page hidden - sending away status");
          // Send away status via WebSocket
          if (window.wsManager) {
            window.wsManager.send({
              type: "PRESENCE_UPDATE",
              status: "away",
              timestamp: new Date().toISOString()
            });
          }
        } else {
          console.log("üìÑ Page visible - sending online status");
          // Send online status and refresh
          if (window.wsManager) {
            window.wsManager.send({
              type: "PRESENCE_UPDATE",
              timestamp: new Date().toISOString()
            });
          }
          // Refresh data
          if (window.messagesPage) {
            window.messagesPage.loadConversations();
          }
        }
      }
    });

    // Handle beforeunload
    window.addEventListener("beforeunload", () => {
      console.log("üîÑ Page unloading - cleaning up...");
      if (window.messagesPage) {
        window.messagesPage.stopTypingIndicator();
        
        // Send away status
        if (window.wsManager) {
          window.wsManager.send({
            type: "PRESENCE_UPDATE",
            status: "away",
            timestamp: new Date().toISOString()
          });
        }
      }
    });

    // Debug functions
    function toggleDebug() {
      const panel = document.getElementById('debugPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function testWebSocket() {
      console.log("üß™ Testing WebSocket...");
      if (window.wsManager) {
        // Test WebSocket connection
        window.wsManager.send({
          type: "DEBUG_REQUEST",
          message: "Manual test from debug panel",
          timestamp: new Date().toISOString(),
          userId: window.currentUser?.id
        });
        
        // Update debug info
        updateDebugInfo();
      } else {
        console.log("‚ùå wsManager not available");
      }
    }

    function getWebSocketState(state) {
      const states = {
        0: 'CONNECTING',
        1: 'OPEN',
        2: 'CLOSING',
        3: 'CLOSED'
      };
      return states[state] || 'UNKNOWN';
    }

    function updateDebugInfo() {
      let info = '';
      
      if (window.wsManager?.ws) {
        const ws = window.wsManager.ws;
        info += `
          <div>WS State: ${getWebSocketState(ws.readyState)} (${ws.readyState})</div>
          <div>Connected: ${ws.readyState === 1 ? '‚úÖ' : '‚ùå'}</div>
        `;
      } else {
        info += `<div>WS Manager: Not initialized</div>`;
      }
      
      info += `
        <div>User ID: ${window.currentUser?.id || 'Not logged in'}</div>
        <div>Username: ${window.currentUser?.username || 'None'}</div>
        <div>Current Conv: ${window.messagesPage?.currentConversation?.id || 'None'}</div>
        <div>MessagesPage: ${window.messagesPage ? '‚úÖ' : '‚ùå'}</div>
        <div>wsManager: ${window.wsManager ? '‚úÖ' : '‚ùå'}</div>
      `;
      
      document.getElementById('debugInfo').innerHTML = info;
    }

    // Update debug info every 3 seconds
    setInterval(updateDebugInfo, 3000);

    // Add keyboard shortcut for debug (Ctrl+Shift+D)
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        toggleDebug();
        e.preventDefault();
      }
      // Alt+Shift+D also works
      if (e.altKey && e.shiftKey && e.key === 'D') {
        toggleDebug();
        e.preventDefault();
      }
    });

    // New chat button handler
    document.getElementById('newChatBtn').addEventListener('click', () => {
      const userId = prompt("Enter user ID to start chat:");
      if (userId && window.messagesPage) {
        window.messagesPage.startConversationWithUser(userId);
      }
    });

    // Search clear button handler
    document.getElementById('searchClearBtn').addEventListener('click', () => {
      const searchInput = document.getElementById('searchConversations');
      searchInput.value = '';
      if (window.messagesPage) {
        window.messagesPage.filterConversations('');
      }
    });

    // Back button handler
    document.getElementById('backToList').addEventListener('click', () => {
      if (window.messagesPage) {
        window.messagesPage.closeChat();
      }
    });
  </script>

  <!-- Inline CSS for loading skeleton -->
  <style>
    .conversation-skeleton {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
    }
    
    .avatar-skeleton {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    .info-skeleton {
      flex: 1;
    }
    
    .line-skeleton {
      height: 12px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    
    .line-skeleton.short {
      width: 70%;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</body>
</html>