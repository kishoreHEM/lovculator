<!DOCTYPE html>
<html>
<head>
    <title>Real-time Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .panel { flex: 1; border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
        button { background: #ff4b8d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin-top: 10px; border-radius: 5px; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Real-time Messaging Test</h1>
    
    <div class="container">
        <div class="panel">
            <h3>User A (You)</h3>
            <div>User ID: <input type="text" id="userIdA" value="9" readonly></div>
            <button onclick="sendTypingA()">Simulate Typing</button>
            <button onclick="sendMessageA()">Send Test Message</button>
        </div>
        
        <div class="panel">
            <h3>User B (Other)</h3>
            <div>User ID: <input type="text" id="userIdB" placeholder="Enter other user ID"></div>
            <div id="typingStatusB">Not typing</div>
            <div id="messageStatusB">No messages</div>
        </div>
    </div>
    
    <h3>WebSocket Logs:</h3>
    <div id="wsLog" class="log"></div>
    
    <script>
        let ws = null;
        let userIdB = null;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('wsLog');
            const entry = document.createElement('div');
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const host = window.location.hostname === 'localhost' ? 'localhost:3001' : window.location.host;
            const wsUrl = `${protocol}://${host}`;
            
            log(`Connecting to: ${wsUrl}`);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('âœ… WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    log(`ðŸ“¨ Received: ${msg.type}`);
                    
                    if (msg.type === 'TYPING') {
                        document.getElementById('typingStatusB').innerHTML = 
                            msg.isTyping ? 'âŒ¨ï¸ User is typing...' : 'Not typing';
                    } else if (msg.type === 'NEW_MESSAGE') {
                        document.getElementById('messageStatusB').innerHTML = 
                            `New message: ${msg.message?.message_text || 'No text'}`;
                    }
                } catch (e) {
                    log(`âŒ Parse error: ${e.message}`);
                }
            };
            
            ws.onerror = (error) => {
                log(`âŒ WebSocket error: ${error}`);
            };
        }
        
        function sendTypingA() {
            userIdB = document.getElementById('userIdB').value;
            if (!userIdB) {
                alert('Enter User B ID');
                return;
            }
            
            const typingMsg = {
                type: 'TYPING',
                conversationId: 1, // Test conversation ID
                isTyping: true,
                toUserId: parseInt(userIdB),
                timestamp: new Date().toISOString(),
                fromUserId: 9
            };
            
            ws.send(JSON.stringify(typingMsg));
            log(`ðŸ“¤ Sent typing: ${JSON.stringify(typingMsg)}`);
            
            // Stop typing after 2 seconds
            setTimeout(() => {
                typingMsg.isTyping = false;
                ws.send(JSON.stringify(typingMsg));
                log(`ðŸ“¤ Stopped typing`);
            }, 2000);
        }
        
        function sendMessageA() {
            // This would need actual API call
            log('ðŸ“¤ Message sent via API (check server logs)');
        }
        
        // Auto-connect
        window.onload = connectWebSocket;
    </script>
</body>
</html>