<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= story.story_title %> | Lovculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="stylesheet" href="/css/style.css">
  
  <style>
    /* ‚úÖ 1. Main Container - Desktop First */
    .story-detail-container {
      max-width: 700px;
      margin: 30px auto;
      background: #fff;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .story-header h1 { 
      font-size: 2.2rem; 
      color: #1a1a1a; 
      margin-bottom: 12px; 
      line-height: 1.3;
    }

    .meta-info { 
      color: #666; 
      font-size: 0.95rem; 
      margin-bottom: 25px; 
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    /* ‚úÖ 2. Image Handling */
    .story-detail-container img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 25px;
      display: block;
    }

    /* ‚úÖ 3. Story Text */
    .story-body {
      white-space: pre-wrap;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.8;
      color: #2c3e50;
      font-size: 1.15rem;
    }

    /* ‚úÖ 4. Action Bar (Like/Comment/Share) */
    .action-bar {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 25px;
      align-items: center;
    }

    .action-btn {
      background: #f8f9fa; /* Light gray background for better touch targets */
      border: none; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      gap: 8px;
      font-size: 1rem; 
      color: #555;
      padding: 10px 18px;
      border-radius: 25px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .action-btn:hover { background: #f0f0f0; }
    .action-btn.liked { color: #e74c3c; background: #fff0f0; }
    
    /* =========================================
       üì± MOBILE RESPONSIVE STYLES
       ========================================= */
    @media (max-width: 600px) {
        .story-detail-container {
          margin: 0;
          padding: 20px;
          width: 100%;
          max-width: 100%;
          border-radius: 0;
          box-shadow: none;

          /* ‚úÖ FIX: Add extra space at the bottom so the Menu Bar doesn't cover text */
          padding-bottom: 100px; 
        }

        .story-header h1 {
          font-size: 1.6rem;
        }

        .story-body {
          font-size: 1rem;
          line-height: 1.6;
        }

        .action-bar {
          justify-content: space-between;
          gap: 10px;
        }

        .action-btn {
          padding: 8px 12px;
          font-size: 0.9rem;
        }
      }
  </style>
</head>

<body class="app-layout">

<%- include('../../frontend/components/header.html') %> 

<main class="story-detail-container">
  
  <a href="/love-stories" style="display:inline-block; margin-bottom:20px; text-decoration:none; color:#666; font-size:0.9rem;">
    ‚Üê Back to Stories
  </a>

  <article>
    <div class="story-header">
      <h1><%= story.story_title %></h1>
      <div class="meta-info">
        By <strong><%= story.anonymous_post ? 'Anonymous' : (story.display_name || story.username) %></strong>
        ¬∑ <%= new Date(story.created_at).toDateString() %>
        <% if(story.couple_names) { %> | ‚ù§Ô∏è <%= story.couple_names %> <% } %>
      </div>
    </div>

    <% if (story.image_url) { %>
      <img src="<%= story.image_url %>" alt="Story Image">
    <% } %>

    <section class="story-body">
      <%= story.love_story %>
    </section>

    <div class="action-bar">
      <button class="action-btn <%= story.user_liked ? 'liked' : '' %>" id="likeBtn" onclick="toggleLike()">
        <span id="likeIcon"><%= story.user_liked ? '‚ù§Ô∏è' : 'ü§ç' %></span>
        <span id="likeCount"><%= story.likes_count || 0 %></span> Likes
      </button>

      <button class="action-btn">
        üí¨ <%= story.comments_count || 0 %> Comments
      </button>

      <button class="action-btn" onclick="shareStory()">
        üöÄ Share
      </button>
    </div>
  </article>
</main>

<script>
  // Pass server-side data to client-side JS safely
  const storyId = "<%= story.id %>";
  
  // ‚úÖ FIXED: Wrapped EJS in quotes to satisfy editor linter, then compared to string "true"
  const userLoggedIn = "<%= (typeof user !== 'undefined' && user) ? 'true' : 'false' %>" === "true";

  async function toggleLike() {
    if (!userLoggedIn) {
      alert("Please login to like stories!");
      window.location.href = "/login";
      return;
    }

    const btn = document.getElementById("likeBtn");
    
    try {
      const res = await fetch(`/api/stories/${storyId}/like`, { 
        method: "POST",
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (res.ok) {
        const data = await res.json();
        
        // Update Count
        document.getElementById("likeCount").innerText = data.likes_count;
        const icon = document.getElementById("likeIcon");
        
        // Update visual state
        if (data.is_liked) {
          btn.classList.add("liked");
          icon.innerText = "‚ù§Ô∏è";
        } else {
          btn.classList.remove("liked");
          icon.innerText = "ü§ç";
        }
      } else {
          console.error("Server returned error on like");
      }
    } catch (err) {
      console.error("Like failed", err);
    }
  }

  function shareStory() {
    if (navigator.share) {
      navigator.share({
        title: "<%= story.story_title %>",
        text: "Check out this love story on Lovculator!",
        url: window.location.href
      }).catch(err => console.log('Share dismissed', err));
    } else {
      // Fallback for desktop browsers
      navigator.clipboard.writeText(window.location.href)
        .then(() => alert("Link copied to clipboard!"))
        .catch(err => console.error("Could not copy link", err));
    }
  }
</script>

</body>
</html>