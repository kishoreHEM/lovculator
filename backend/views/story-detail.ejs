<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= story.story_title %> | Lovculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* Specific overrides for the detail page layout */
    .story-detail-container {
      max-width: 700px;
      margin: 30px auto;
      background: #fff;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    .story-body { white-space: pre-line; line-height: 1.8; color: #2c3e50; font-size: 1.15rem; margin-bottom: 30px; }
    
    /* Ensure the comments section isn't hidden by default if you want it open, 
       otherwise use the 'hidden' class from your CSS */
    .hidden { display: none; }

    @media (max-width: 600px) {
      .story-detail-container { padding: 20px; margin: 0; border-radius: 0; padding-bottom: 100px; }
    }
  </style>
</head>

<body class="app-layout">
<%- include('../../frontend/components/header.html') %> 

<main class="story-detail-container">
  <article>
    <div class="story-header">
      <h1><%= story.story_title %></h1>
      <div class="meta-info" style="color:#666; margin-bottom:20px;">
        By <strong><%= story.anonymous_post ? 'Anonymous' : (story.display_name || story.username) %></strong>
        Â· <%= new Date(story.created_at).toDateString() %>
      </div>
    </div>

    <% if (story.image_url) { %>
      <img src="<%= story.image_url %>" style="width:100%; border-radius:8px; margin-bottom:20px;">
    <% } %>

    <section class="story-body"><%= story.love_story %></section>

    <div class="post-actions">
        <button class="post-action like-btn <%= story.user_liked ? 'liked' : '' %>" 
                id="likeBtn" onclick="toggleLike()">
            <svg width="20" height="20" viewBox="0 0 24 24" 
                 fill="<%= story.user_liked ? '#e91e63' : 'none' %>" 
                 stroke="<%= story.user_liked ? '#e91e63' : 'currentColor' %>" 
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span class="like-count" id="likeCount"><%= story.likes_count || 0 %></span>
        </button>

        <button class="post-action comment-btn" onclick="toggleCommentBox()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
            <span class="comment-count" id="commentCountTop"><%= story.comments_count || 0 %></span>
        </button>

        <button class="post-action share-btn" onclick="shareStory()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
            </svg>
        </button>
    </div>

    <div class="comments-section hidden" id="commentSection">
        <div class="comment-form">
            <input type="text"
                   id="commentText"
                   class="comment-input"
                   placeholder="Add a comment...">
            <button class="comment-submit" onclick="postComment()">Post</button>
        </div>
        <div class="comments-list" id="commentsList"></div>
    </div>
  </article>
</main>

<script>
  const storyId = "<%= story.id %>";
  const userLoggedIn = "<%= (typeof user !== 'undefined' && user) ? 'true' : 'false' %>" === "true";

  function toggleCommentBox() {
    const box = document.getElementById("commentSection");
    box.classList.toggle("hidden");
    if (!box.classList.contains("hidden")) loadComments();
  }

  async function toggleLike() {
    if (!userLoggedIn) { alert("Please login to like!"); window.location.href = "/login"; return; }
    try {
      const res = await fetch(`/api/stories/${storyId}/like`, { method: "POST" });
      const data = await res.json();
      
      const likeBtn = document.getElementById("likeBtn");
      const likeSvg = likeBtn.querySelector("svg");
      const likeCount = document.getElementById("likeCount");

      likeCount.innerText = data.likes_count;
      if (data.is_liked) {
        likeBtn.classList.add("liked");
        likeSvg.setAttribute("fill", "#e91e63");
        likeSvg.setAttribute("stroke", "#e91e63");
      } else {
        likeBtn.classList.remove("liked");
        likeSvg.setAttribute("fill", "none");
        likeSvg.setAttribute("stroke", "currentColor");
      }
    } catch (err) { console.error(err); }
  }

  async function postComment() {
    const input = document.getElementById("commentText");
    const text = input.value.trim();
    if (!text || !userLoggedIn) return;

    try {
      const res = await fetch(`/api/stories/${storyId}/comments`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text })
      });
      if (res.ok) {
        input.value = "";
        loadComments();
      }
    } catch (err) { console.error(err); }
  }

  async function loadComments() {
    const list = document.getElementById("commentsList");
    try {
      const res = await fetch(`/api/stories/${storyId}/comments`);
      const comments = await res.json();
      document.getElementById("commentCountTop").innerText = comments.length;

      list.innerHTML = comments.map(c => `
        <div class="comment-item" style="margin-top:10px; padding:10px; background:#f8f9fa; border-radius:8px;">
            <div style="font-weight:bold; font-size:0.85rem;">${c.author_name || 'Anonymous'}</div>
            <div style="font-size:0.9rem;">${c.comment_text}</div>
        </div>
      `).join('');
    } catch (err) { list.innerHTML = "Error loading comments."; }
  }

  function shareStory() {
    if (navigator.share) {
      navigator.share({ title: "<%= story.story_title %>", url: window.location.href });
    } else {
      navigator.clipboard.writeText(window.location.href);
      alert("Link copied!");
    }
  }
</script>
</body>
</html>